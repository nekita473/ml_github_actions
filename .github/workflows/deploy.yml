name: Model Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build and push Docker image
        run: |
          docker build -t ghcr.io/${{ github.repository }}:${{ github.sha }} .
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: Deploy to Yandex Cloud COI VM
        uses: yc-actions/yc-coi-deploy@v2
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          folder-id: ${{ secrets.YC_FOLDER_ID }}
          vm-name: my-app-vm
          image: ghcr.io/${{ github.repository }}:${{ github.sha }}
          # Optional: If you need to replace an existing VM
          replace-vm-if-exists: true
          # Optional: Add public IP if needed
          assign-public-ip: true
          # Optional: Specify subnet
          # vm-subnet-id: ${{ secrets.YC_SUBNET_ID }}
      
      - name: Verify deployment
        run: |
          # Get VM IP
          VM_IP=$(yc compute instance get my-app-vm \
            --format json | jq -r '.network_interfaces[0].primary_v4_address.one_to_one_nat.address')
          
          # Test the application
          curl -f http://$VM_IP/health || echo "Deployment verification failed"